DROP PROCEDURE IF EXISTS UPDATE_USER_REGISTER;
DELIMITER $$
CREATE PROCEDURE UPDATE_USER_REGISTER( IN email VARCHAR(64), IN pw VARCHAR(65), IN NAME VARCHAR(30) CHARACTER SET UTF8MB4, IN lang VARCHAR(5))
BEGIN
	INSERT INTO users(EMAIL, PASSWORD, NAME, LANGUAGE) VALUE (email, pw, NAME, lang);
END $$
DELIMITER ;

CALL VIEW_SEARCH_EMAIL(1, '@');

BEGIN
	SET @sqlQuery = CONCAT('SELECT ID, EMAIL, NAME, LANGUAGE, IMG_URL FROM users ',
					'LEFT OUTER JOIN (SELECT * FROM relations WHERE USER_ID = ', userId, ') AS relations ',
					'ON ID = TARGET_ID WHERE EMAIL LIKE "%', factor, '%" AND ID != ', userId, ' AND TARGET_ID IS NULL');
	PREPARE SEARCH_EMAIL FROM @sqlQuery;
	EXECUTE SEARCH_EMAIL;
	DEALLOCATE PREPARE SEARCH_EMAIL;
END