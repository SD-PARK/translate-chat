<html>
    <head>
        <meta charset="utf-8">
        <title>GitHub Commit Example</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
        <style>
            hr { margin : 7px 0px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h3>Socket.io Chat Example</h3>
            <form class="form-horizontal">
                <div class="form-group">
                    <button id="room1" class="btn btn-info">Join Room1</button>
                    <button id="room2" class="btn btn-info">Join Room2</button>
                </div>
                <div class="form-group">
                    <label>Room Number: </label>
                    <label id="roomNum">None</label> 
                </div>
                <div class="form-inline form-group">
                    <label for="msgForm">Send: </label>
                    <input type="text" id="msgForm" class="form-control" onkeypress="if(event.keyCode==13){$('form').submit()}">
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
            <div id="chatLogs"></div>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
            <script src="/socket.io/socket.io.js"></script>
            <script>
                const socket = io();
                const name = makeRandomName();
                let room = '';

                // 접속 시 유저 정보를 서버에 전송
                socket.emit('login', {
                    name: name,
                    userid: name + '@gmail.com'
                });

                // 1번 방 선택 시
                $('#room1').click((e) => {
                    e.preventDefault();
                    roomSelect('1');
                });

                // 2번 방 선택 시
                $('#room2').click((e) => {
                    e.preventDefault();
                    roomSelect('2');
                });

                // 유저 방 입장 이벤트
                socket.on('joinRoom', (name) => {
                    $('#chatLogs').append('<div>' + name + ' has joined Room ' + room + '</div><hr>');
                });

                // Send 버튼 클릭 시
                $('form').submit((e) => {
                    e.preventDefault();
                    if (room == '') {
                        $('#chatLogs').append('<div><strong>No Room Selected.</strong></div><hr>');
                    } else {
                        let $msgForm = $('#msgForm');

                        socket.emit('chat', $msgForm.val());
                        $msgForm.val('');
                    }
                });

                // 서버에서 채팅 메시지와 유저 네임, 시간을 받아와 출력
                socket.on('chat', (data) => {
                    $('#chatLogs').append('<div><strong>' + data.name + '</strong>: ' + data.msg + '<div style="float:right;">' + data.time + '</div></div><hr>');
                });

                // 무작위 닉네임 생성(영문 3글자, 숫자 2글자)
                function makeRandomName() {
                    let name = '';
                    let possible = 'abcdefghijklmnopqrstuvwyz';
                    let possibleNum = '1234567890';

                    for(let i=0; i<3; i++)
                        name += possible.charAt(Math.floor(Math.random() * possible.length));
                    for(let i=0; i<2; i++)
                        name += possibleNum.charAt(Math.floor(Math.random() * possibleNum.length));
                    
                    return name;
                }

                // 방 선택 함수
                function roomSelect(roomNum) {
                    if(room != roomNum) {
                        room = roomNum;
                        socket.emit('joinRoom', roomNum);
                        $('#roomNum').text(roomNum);
                        $('#chatLogs').empty();
                    }
                }
            </script>
        </div>
    </body>
</html>